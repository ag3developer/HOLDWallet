# ğŸ”„ FLUXO COMPLETO: Compra e Venda OTC InstantÃ¢neo

## ğŸ“Š VisÃ£o Geral dos Dois CenÃ¡rios

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           HOLD WALLET OTC                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   COMPRA (BUY)                        VENDA (SELL)                          â”‚
â”‚   UsuÃ¡rio recebe crypto               UsuÃ¡rio envia crypto                  â”‚
â”‚   Plataforma recebe BRL               Plataforma envia BRL                  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ Platform Wallet â”‚ â”€â”€â”€â”€â”€â”€â”€â†’       â”‚ User Wallet     â”‚ â”€â”€â”€â”€â”€â”€â”€â†’          â”‚
â”‚   â”‚ (Private Key)   â”‚  crypto        â”‚ (Custodial Key) â”‚  crypto           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚          â”‚                                   â”‚                              â”‚
â”‚          â–¼                                   â–¼                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ User Wallet     â”‚                 â”‚ Platform Wallet â”‚                   â”‚
â”‚   â”‚ (Blockchain)    â”‚                 â”‚ (Blockchain)    â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“— CENÃRIO 1: COMPRA (BUY) - UsuÃ¡rio compra crypto

### Fluxo Visual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USUÃRIO COMPRA 100 USDT                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  1ï¸âƒ£ UsuÃ¡rio cria ordem de compra                                 â”‚
â”‚      POST /instant-trade/create                                   â”‚
â”‚      Status: PENDING                                              â”‚
â”‚                     â†“                                             â”‚
â”‚  2ï¸âƒ£ UsuÃ¡rio paga R$ 580 via TED/PIX                              â”‚
â”‚      Upload do comprovante                                        â”‚
â”‚                     â†“                                             â”‚
â”‚  3ï¸âƒ£ â­ ADMIN verifica comprovante                                â”‚
â”‚      PÃ¡gina: /admin/trades/{trade_id}                            â”‚
â”‚      Clica: "Confirmar Pagamento"                                 â”‚
â”‚      Status: PAYMENT_CONFIRMED                                    â”‚
â”‚                     â†“                                             â”‚
â”‚  4ï¸âƒ£ Sistema AUTOMATICAMENTE:                                     â”‚
â”‚      â€¢ Usa PLATFORM_WALLET_PRIVATE_KEY                           â”‚
â”‚      â€¢ Assina transaÃ§Ã£o blockchain                               â”‚
â”‚      â€¢ Envia 100 USDT â†’ User Wallet                              â”‚
â”‚      â€¢ Registra tx_hash                                          â”‚
â”‚      Status: COMPLETED                                            â”‚
â”‚                     â†“                                             â”‚
â”‚  âœ… CONCLUÃDO                                                     â”‚
â”‚                                                                   â”‚
â”‚  ğŸ“Œ CHAVE USADA: PLATFORM_WALLET_PRIVATE_KEY (da empresa)        â”‚
â”‚  ğŸ“ ARQUIVO: blockchain_deposit_service.py                        â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Arquivos Envolvidos

- `backend/app/services/blockchain_deposit_service.py` - ServiÃ§o de depÃ³sito
- `backend/app/routers/admin/trades.py` - Endpoint `confirm-payment`
- `Frontend/src/pages/admin/AdminTradeDetailPage.tsx` - BotÃ£o "Confirmar Pagamento"

### VariÃ¡veis de Ambiente

```env
PLATFORM_WALLET_PRIVATE_KEY=0x...  # Chave privada da carteira da empresa
```

---

## ğŸ“• CENÃRIO 2: VENDA (SELL) - UsuÃ¡rio vende crypto

### Fluxo Visual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USUÃRIO VENDE 100 USDT                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  1ï¸âƒ£ UsuÃ¡rio cria ordem de venda                                  â”‚
â”‚      POST /instant-trade/create                                   â”‚
â”‚      Status: PENDING                                              â”‚
â”‚                     â†“                                             â”‚
â”‚  2ï¸âƒ£ â­ ADMIN verifica e processa venda                           â”‚
â”‚      PÃ¡gina: /admin/trades/{trade_id}                            â”‚
â”‚      Clica: "Processar Venda"                                     â”‚
â”‚                     â†“                                             â”‚
â”‚  3ï¸âƒ£ Sistema AUTOMATICAMENTE:                                     â”‚
â”‚      â€¢ Busca Address do usuÃ¡rio (com encrypted_private_key)      â”‚
â”‚      â€¢ Descriptografa chave privada CUSTODIAL do usuÃ¡rio         â”‚
â”‚      â€¢ Verifica saldo do usuÃ¡rio                                 â”‚
â”‚      â€¢ Transfere 100 USDT: User Wallet â†’ Platform Wallet         â”‚
â”‚      â€¢ Registra tx_hash                                          â”‚
â”‚      Status: CRYPTO_RECEIVED                                      â”‚
â”‚                     â†“                                             â”‚
â”‚  4ï¸âƒ£ ADMIN processa pagamento BRL                                 â”‚
â”‚      â€¢ Envia PIX/TED para conta bancÃ¡ria do usuÃ¡rio              â”‚
â”‚      â€¢ Valor: R$ 580 (fiat_amount)                               â”‚
â”‚                     â†“                                             â”‚
â”‚  5ï¸âƒ£ ADMIN finaliza venda                                         â”‚
â”‚      Clica: "Finalizar Venda"                                     â”‚
â”‚      Status: COMPLETED                                            â”‚
â”‚                     â†“                                             â”‚
â”‚  âœ… CONCLUÃDO                                                     â”‚
â”‚                                                                   â”‚
â”‚  ğŸ“Œ CHAVE USADA: User.encrypted_private_key (custodial)          â”‚
â”‚  ğŸ“ ARQUIVO: blockchain_withdraw_service.py                       â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Arquivos Envolvidos (NOVOS)

- `backend/app/services/blockchain_withdraw_service.py` - **NOVO** ServiÃ§o de retirada
- `backend/app/routers/admin/trades.py` - Endpoints `process-sell` e `complete-sell`
- `Frontend/src/pages/admin/AdminTradeDetailPage.tsx` - BotÃµes "Processar Venda" e "Finalizar Venda"

### VariÃ¡veis de Ambiente

```env
PLATFORM_WALLET_ADDRESS=0x...  # EndereÃ§o da carteira da empresa (destino das vendas)
ENCRYPTION_KEY=...             # Chave para descriptografar private keys dos usuÃ¡rios
```

---

## ğŸ”‘ SeguranÃ§a: Onde Ficam as Chaves

### Chave da Plataforma (COMPRA)

```
Arquivo: .env
VariÃ¡vel: PLATFORM_WALLET_PRIVATE_KEY=0x...

Usado em: blockchain_deposit_service.py
Para: Enviar crypto da plataforma para usuÃ¡rios
```

### Chaves dos UsuÃ¡rios (VENDA - Custodial)

```
Banco de Dados: addresses.encrypted_private_key

Criptografada com: ENCRYPTION_KEY (Fernet)
Descriptografada em: crypto_service.decrypt_data()
Usada em: blockchain_withdraw_service.py
Para: Transferir crypto do usuÃ¡rio para a plataforma
```

---

## ğŸ–¥ï¸ Interface Admin - BotÃµes por Status

### Trade de COMPRA (BUY)

| Status            | BotÃ£o DisponÃ­vel      | AÃ§Ã£o                              |
| ----------------- | --------------------- | --------------------------------- |
| PENDING           | "Confirmar Pagamento" | Confirma pagamento + Envia crypto |
| PAYMENT_CONFIRMED | "Retry DepÃ³sito"      | Tenta novamente se falhou         |
| COMPLETED         | "Contabilidade"       | Registra fees                     |
| FAILED            | "Retry DepÃ³sito"      | Tenta novamente                   |

### Trade de VENDA (SELL) - **NOVO**

| Status          | BotÃ£o DisponÃ­vel  | AÃ§Ã£o                      |
| --------------- | ----------------- | ------------------------- |
| PENDING         | "Processar Venda" | Retira crypto do usuÃ¡rio  |
| CRYPTO_RECEIVED | "Finalizar Venda" | Confirma envio do PIX/TED |
| COMPLETED       | "Contabilidade"   | Registra fees             |

---

## ğŸ“Š Status do Trade

```
COMPRA (BUY):
PENDING â†’ PAYMENT_CONFIRMED â†’ COMPLETED
                           â†˜ FAILED (retry disponÃ­vel)

VENDA (SELL):
PENDING â†’ CRYPTO_RECEIVED â†’ COMPLETED
                         â†˜ FAILED
```

### Novo Status Adicionado

- `CRYPTO_RECEIVED` - Crypto recebida da wallet do usuÃ¡rio, aguardando envio de PIX/TED

---

## ğŸ§ª Como Testar

### 1. Teste de COMPRA (BUY)

```bash
# 1. Criar ordem de compra como usuÃ¡rio
POST /instant-trade/create
{
  "quote_id": "xxx",
  "payment_method": "ted"
}

# 2. Como admin, confirmar pagamento
POST /admin/trades/{trade_id}/confirm-payment
{
  "network": "polygon"
}

# Resultado esperado:
# - Crypto enviada para user wallet
# - tx_hash registrado
# - Status: COMPLETED
```

### 2. Teste de VENDA (SELL)

```bash
# 1. Criar ordem de venda como usuÃ¡rio
POST /instant-trade/create
{
  "quote_id": "xxx",
  "payment_method": "ted"
}

# 2. Como admin, processar venda
POST /admin/trades/{trade_id}/process-sell
{
  "network": "polygon"
}

# Resultado esperado:
# - Crypto retirada do user wallet
# - Enviada para platform wallet
# - Status: CRYPTO_RECEIVED

# 3. Como admin, finalizar apÃ³s enviar PIX
POST /admin/trades/{trade_id}/complete-sell

# Resultado esperado:
# - Status: COMPLETED
```

---

## âš ï¸ Importante

1. **Wallets Custodiais**: A plataforma guarda as chaves privadas dos usuÃ¡rios criptografadas. Isso permite movimentar os fundos sem necessidade de MetaMask.

2. **SeguranÃ§a**: As chaves sÃ£o criptografadas com Fernet (ENCRYPTION_KEY). Mantenha essa chave segura!

3. **AprovaÃ§Ã£o Manual**: Tanto COMPRA quanto VENDA requerem aprovaÃ§Ã£o manual do admin. NÃ£o Ã© automÃ¡tico.

4. **Ordem das OperaÃ§Ãµes (SELL)**:

   - Primeiro retira a crypto do usuÃ¡rio
   - Depois envia o PIX/TED (processo externo)
   - Por Ãºltimo marca como COMPLETED

5. **VariÃ¡veis de Ambiente NecessÃ¡rias**:
   ```env
   PLATFORM_WALLET_PRIVATE_KEY=0x...
   PLATFORM_WALLET_ADDRESS=0x...
   ENCRYPTION_KEY=...
   POLYGON_RPC_URL=https://...
   ```
